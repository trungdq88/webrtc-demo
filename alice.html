<h1>Alice (Sender)</h1>

<video id="video" autoplay></video>

<textarea
       id="dataSend"
       onkeyup="sendData(event)"
       placeholder="Press Start, enter some text, then press Send."></textarea>

<script src="/socket.io/socket.io.js"></script>
<script src="adapter.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>

<script>
// Socket connection
var socket = io.connect();

// STUN & TURN servers
var peerConnectionConfig = null;

// List of all Bobs {key: value}
// key: string of bob name (socket id)
// value: RTCPeerConnection
var pcList = {};

// Video stream from camera
var videoStream;

// Global data channel so that we can send text from <textarea> element
var dataChannel;

// Request camera
navigator.mediaDevices.getUserMedia({
  audio: false,
  video: true,
})
.then(function (stream) {
  console.log('Alice\'s webcam is ready!');
  // Show video stream to the <video> element
  document.getElementById('video').srcObject = videoStream = stream;
});

// Get STUN && TURN server
$.get("https://service.xirsys.com/ice", {
  ident: "quangtrung",
  secret: "enter-your-secret",
  domain: "webrtc-demo-geeky.herokuapp.com",
  application: "default",
  room: "default",
  secure: 1
},
function(data, status) {
  peerConnectionConfig = data.d;
});

// Tell the signalling server that I am Alice
socket.emit('i-am-alice');
console.log('Told the signalling server that Alice is here.');

// Wait for Bob
socket.on('bob-is-coming', function (bob) {
  console.log(bob, ' want to connect.');

  // Create peer connection for Bob
  var peerConnection = pcList[bob] = new RTCPeerConnection(peerConnectionConfig);

  // Be ready to send the candidate infomation to Bob
  // Candidate infomation will be available when an offer is created
  peerConnection.onicecandidate = function (event) {
    console.log('Sent ICE candidate information to ', bob);
    if (event.candidate) {
      socket.emit('alice-sending-ice-candidate', {
        bobName: bob,
        candidate: event.candidate,
      });
    }
  };

  // Add video stream to the peer connection
  peerConnection.addStream(videoStream);

  // Add data channel to the peer connection
  dataChannel = peerConnection.createDataChannel('text');

  console.log('An RTCPeerConnection with video stream is created for ', bob);

  // Create an offer
  peerConnection.createOffer().then(function (sessionDescription) {
    // Set description as local description
    peerConnection.setLocalDescription(sessionDescription);

    // Send sessionDescription to Bob
    socket.emit('alice-offer-a-session', {
      bobName: bob,
      sessionDescription: sessionDescription,
    });

    console.log('Alice sent an offer to ', bob);
  });
});

// Wait for Bob to answer the offer
socket.on('bob-answer-the-offer', function (data) {
  console.log(data.bobName, ' accepted the offer.');
  // Set Bob's sessionDescription as remote description
  pcList[data.bobName].setRemoteDescription(data.sessionDescription);
});

// Receive ICE candidate info from Bob
socket.on('bob-sending-ice-candidate', function (data) {
  console.log('Received an ICE candidate from ', data.bobName);
  // Update ICE candidate info
  pcList[data.bobName].addIceCandidate(new RTCIceCandidate(data.candidate));
});

socket.on('bob-is-leaving', function (bob) {
  console.log(bob, ' has left. Bye, ', bob);
  delete pcList[bob];
});

function sendData(e) {
  dataChannel.send(e.target.value);
}
</script>

